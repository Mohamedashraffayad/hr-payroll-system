<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mido System - HR & Payroll</title>
<style>
:root{--primary:#1565C0;--primary-dark:#0D47A1;--primary-light:#BBDEFB;--success:#2E7D32;--success-light:#C8E6C9;--warning:#F57C00;--warning-light:#FFE0B2;--danger:#C62828;--danger-light:#FFCDD2;--gray-50:#FAFAFA;--gray-100:#F5F5F5;--gray-200:#EEEEEE;--gray-400:#BDBDBD;--gray-500:#9E9E9E;--gray-600:#757575;--gray-700:#616161;--gray-800:#424242;--gray-900:#212121}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--gray-50);color:var(--gray-800);line-height:1.6}
.sidebar{position:fixed;left:0;top:0;width:260px;height:100vh;background:linear-gradient(180deg,#0D47A1 0%,#1565C0 50%,#1976D2 100%);display:flex;flex-direction:column;z-index:100;overflow-y:auto}
.sidebar-logo{padding:24px 20px;border-bottom:1px solid rgba(255,255,255,.15);text-align:center}
.logo-icon{width:60px;height:60px;border-radius:12px;background:rgba(255,255,255,.2);display:inline-flex;align-items:center;justify-content:center;font-size:28px;margin-bottom:12px}
.logo-text h2{color:#fff;font-size:18px;font-weight:700;margin-bottom:4px}
.logo-text p{color:rgba(255,255,255,.7);font-size:12px}
.sidebar-nav{flex:1;padding:12px 0}
.nav-section{padding:12px 16px 4px;font-size:10px;font-weight:700;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1px}
.nav-item{display:flex;align-items:center;gap:12px;padding:11px 20px;color:rgba(255,255,255,.7);cursor:pointer;transition:all .2s;font-size:14px;margin:2px 8px;border-radius:8px;border:none;background:none;width:calc(100% - 16px);text-align:left}
.nav-item:hover{color:#fff;background:rgba(255,255,255,.1)}
.nav-item.active{color:#fff;background:rgba(255,255,255,.2);font-weight:600}
.nav-icon{font-size:18px;width:20px;text-align:center}
.nav-badge{margin-left:auto;background:#EF5350;color:#fff;border-radius:20px;padding:2px 8px;font-size:11px;font-weight:700}
.sidebar-footer{padding:16px;border-top:1px solid rgba(255,255,255,.15)}
.user-card{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.user-avatar{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;font-weight:700}
.user-name{color:#fff;font-size:13px;font-weight:600}
.user-role{color:rgba(255,255,255,.6);font-size:11px}
.logout-btn{width:100%;padding:8px;background:rgba(239,83,80,.25);color:#fff;border:1px solid rgba(239,83,80,.4);border-radius:6px;font-size:12px;cursor:pointer;transition:all .2s}
.logout-btn:hover{background:rgba(239,83,80,.35)}
.header{position:fixed;left:260px;right:0;top:0;height:64px;background:#fff;border-bottom:1px solid var(--gray-200);display:flex;align-items:center;padding:0 24px;gap:16px;z-index:99;box-shadow:0 2px 4px rgba(0,0,0,.05)}
.header-title{font-size:20px;font-weight:700;flex:1;color:var(--primary-dark)}
.lang-btn{padding:8px 16px;border:2px solid var(--primary);border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;color:var(--primary);background:#fff;transition:all .2s}
.lang-btn:hover{background:var(--primary);color:#fff}
.main{margin-left:260px;margin-top:64px;padding:28px;min-height:calc(100vh - 64px)}
.login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#1565C0 0%,#0D47A1 100%);padding:20px}
.login-box{background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);width:100%;max-width:420px;padding:40px}
.login-logo-icon{width:80px;height:80px;background:linear-gradient(135deg,#1565C0,#0D47A1);border-radius:16px;display:inline-flex;align-items:center;justify-content:center;font-size:40px;margin-bottom:15px}
.login-title{font-size:28px;font-weight:800;text-align:center;margin-bottom:8px;color:var(--primary-dark)}
.login-subtitle{font-size:14px;color:var(--gray-500);text-align:center;margin-bottom:30px}
.login-form{display:flex;flex-direction:column;gap:20px}
.login-input{padding:12px 16px;border:2px solid var(--gray-200);border-radius:10px;font-size:15px;transition:all .2s}
.login-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
.login-btn{padding:14px;background:linear-gradient(135deg,#1565C0,#0D47A1);color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s}
.login-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(21,101,192,.4)}
.login-error{background:var(--danger-light);color:var(--danger);padding:12px;border-radius:8px;font-size:13px;display:none;margin-bottom:10px}
.login-error.show{display:block}
.demo-creds{margin-top:20px;padding:15px;background:var(--gray-50);border-radius:10px;font-size:12px;color:var(--gray-600)}
.page{display:none}
.page.active{display:block;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:28px}
.stat-card{background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,.08);border-left:4px solid var(--primary);transition:all .2s}
.stat-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.12)}
.stat-icon{font-size:32px;margin-bottom:12px}
.stat-value{font-size:32px;font-weight:800;line-height:1;color:var(--primary-dark)}
.stat-label{font-size:13px;color:var(--gray-500);margin-top:8px;font-weight:500}
.card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);margin-bottom:24px;overflow:hidden}
.card-header{padding:20px 24px;border-bottom:2px solid var(--gray-100);display:flex;align-items:center;justify-content:space-between;background:var(--gray-50)}
.card-title{font-size:18px;font-weight:700;color:var(--primary-dark)}
.card-body{padding:24px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;border:none}
.btn-primary{background:var(--primary);color:#fff;box-shadow:0 2px 4px rgba(21,101,192,.3)}
.btn-primary:hover{background:var(--primary-dark);box-shadow:0 4px 8px rgba(21,101,192,.4)}
.btn-success{background:var(--success);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-ghost{background:var(--gray-100);color:var(--gray-700)}
.btn-ghost:hover{background:var(--gray-200)}
.btn-sm{padding:6px 14px;font-size:13px}
.badge{display:inline-flex;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase}
.badge-green{background:var(--success-light);color:var(--success)}
.badge-orange{background:var(--warning-light);color:var(--warning)}
.badge-red{background:var(--danger-light);color:var(--danger)}
.badge-blue{background:var(--primary-light);color:var(--primary)}
.table-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:14px}
th{background:var(--primary);color:#fff;padding:12px 16px;text-align:left;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
td{padding:14px 16px;border-bottom:1px solid var(--gray-200)}
tr:hover td{background:var(--gray-50)}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.form-group{display:flex;flex-direction:column;gap:6px}
.form-group.full{grid-column:1/-1}
label{font-size:12px;font-weight:700;color:var(--gray-600);text-transform:uppercase}
input,select,textarea{padding:10px 14px;border:2px solid var(--gray-200);border-radius:8px;font-size:14px;background:#fff;width:100%;transition:all .2s}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}
textarea{resize:vertical;min-height:80px}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;display:none;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:#fff;border-radius:16px;width:700px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.modal-header{padding:20px 24px;border-bottom:2px solid var(--gray-200);display:flex;justify-content:space-between;align-items:center;background:var(--gray-50)}
.modal-title{font-size:20px;font-weight:700;color:var(--primary-dark)}
.modal-close{width:36px;height:36px;border-radius:8px;background:var(--gray-200);border:none;cursor:pointer;font-size:20px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.modal-close:hover{background:var(--danger);color:#fff}
.modal-body{padding:24px}
.modal-footer{padding:16px 24px;border-top:2px solid var(--gray-200);display:flex;gap:10px;justify-content:flex-end;background:var(--gray-50)}
.toast{position:fixed;bottom:28px;right:28px;background:var(--gray-900);color:#fff;padding:16px 24px;border-radius:10px;font-size:14px;z-index:2000;display:none;box-shadow:0 8px 24px rgba(0,0,0,.3)}
.toast.show{display:flex;gap:12px;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.hidden{display:none!important}
.search-box{position:relative;margin-bottom:20px}
.search-input{width:100%;padding:12px 16px 12px 44px;border:2px solid var(--gray-300);border-radius:10px;font-size:15px}
.search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:20px;color:var(--gray-400)}
/* Arabic Report Styles */
.arabic-report{direction:rtl;font-family:'Tahoma',sans-serif;background:#fff}
.report-header-blue{background:linear-gradient(135deg,#1565C0,#0D47A1);color:#fff;padding:16px 20px;text-align:center;border-radius:8px 8px 0 0}
.report-header-blue h1{font-size:22px;margin-bottom:4px;font-weight:700}
.report-header-orange{background:linear-gradient(135deg,#F57C00,#E65100);color:#fff;padding:12px 20px;text-align:center;font-weight:700;font-size:16px;margin:16px 0}
.report-section{margin:16px 0;border:2px solid var(--gray-300);border-radius:8px;overflow:hidden}
.section-header-blue{background:#1976D2;color:#fff;padding:10px 16px;font-weight:700;font-size:14px}
.section-header-orange{background:#F57C00;color:#fff;padding:10px 16px;font-weight:700;font-size:14px}
.section-body{padding:0}
.report-table{width:100%;border-collapse:collapse}
.report-table td{padding:10px 16px;border-bottom:1px solid var(--gray-200);font-size:13px}
.report-table td:first-child{font-weight:700;background:var(--gray-50);width:45%}
.report-table td:last-child{text-align:left}
.report-footer-gold{background:linear-gradient(135deg,#F57C00,#E65100);color:#fff;padding:16px 20px;text-align:center;font-size:20px;font-weight:700;border-radius:0 0 8px 8px}
.reconciliation-table{width:100%;border-collapse:collapse;margin:20px 0}
.reconciliation-table th{background:#B71C1C;color:#fff;padding:12px;text-align:center;font-size:13px}
.reconciliation-table td{padding:12px;text-align:center;border:1px solid var(--gray-300)}
.reconciliation-table .green-row{background:#4CAF50;color:#fff;font-weight:700}
.reconciliation-table .yellow-row{background:#FDD835;font-weight:700}
.reconciliation-table .red-row{background:#EF5350;color:#fff}
@media print{.sidebar,.header,.no-print{display:none!important}.main{margin:0;padding:20px}.modal{box-shadow:none}}
</style>
</head>
<body>

<!-- Login Page -->
<div class="login-container" id="login-page">
<div class="login-box">
<div style="text-align:center">
<div class="login-logo-icon">ğŸ¢</div>
<h1 class="login-title">Mido System</h1>
<p class="login-subtitle">HR & Payroll Management</p>
</div>
<div class="login-error" id="login-error">Invalid username or password</div>
<form class="login-form" onsubmit="handleLogin(event)">
<input type="text" id="username" class="login-input" placeholder="Username" required>
<input type="password" id="password" class="login-input" placeholder="Password" required>
<button type="submit" class="login-btn">Sign In</button>
</form>
<div class="demo-creds">
<strong>Login Credentials:</strong><br>
Admin: <code>admin</code> / <code>admin123</code><br>
Employee: <code>employee1</code> / <code>emp123</code>
</div>
</div>
</div>

<!-- Main App -->
<div id="app-container" class="hidden">
<aside class="sidebar">
<div class="sidebar-logo">
<div class="logo-icon">ğŸ¢</div>
<div class="logo-text">
<h2>Mido System</h2>
<p>ECGS Group</p>
</div>
</div>
<nav class="sidebar-nav" id="sidebar-nav"></nav>
<div class="sidebar-footer">
<div class="user-card">
<div class="user-avatar" id="user-avatar">M</div>
<div>
<div class="user-name" id="user-name">User</div>
<div class="user-role" id="user-role">Role</div>
</div>
</div>
<button class="logout-btn" onclick="handleLogout()">ğŸšª Logout</button>
</div>
</aside>

<header class="header">
<div class="header-title" id="page-title">Dashboard</div>
<button class="lang-btn" onclick="toggleLang()"><span id="lang-label">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span></button>
</header>

<main class="main">
<div class="page active" id="page-dashboard"></div>
<div class="page" id="page-employees"></div>
<div class="page" id="page-reports"></div>
<div class="page" id="page-attendance"></div>
<div class="page" id="page-my-reports"></div>
</main>
</div>

<!-- Employee Search Modal -->
<div class="modal-overlay" id="modal-emp-search">
<div class="modal">
<div class="modal-header">
<div class="modal-title">ğŸ” Search Employee</div>
<button class="modal-close" onclick="closeModal('emp-search')">Ã—</button>
</div>
<div class="modal-body">
<div class="search-box">
<span class="search-icon">ğŸ”</span>
<input type="text" class="search-input" id="search-emp-input" placeholder="Enter Employee ID or Name..." onkeyup="searchEmployees()">
</div>
<div id="search-results"></div>
</div>
</div>
</div>

<!-- Report Viewer Modal -->
<div class="modal-overlay" id="modal-report-viewer">
<div class="modal" style="width:900px;max-width:95vw">
<div class="modal-header">
<div class="modal-title" id="report-title">Report</div>
<div class="no-print" style="display:flex;gap:10px">
<button class="btn btn-sm btn-primary" onclick="downloadReport()">ğŸ“¥ Download PDF</button>
<button class="modal-close" onclick="closeModal('report-viewer')">Ã—</button>
</div>
</div>
<div class="modal-body" style="padding:0">
<div id="report-viewer" style="padding:40px"></div>
</div>
</div>
</div>

<div class="toast" id="toast"><span id="toast-icon"></span><span id="toast-msg"></span></div>

<script>
const API_URL = 'http://localhost:8000/api';
let currentUser = null;
let allEmployees = [];

// Authentication
async function handleLogin(e) {
  e.preventDefault();
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  
  try {
    const response = await fetch(`${API_URL}/login?username=${username}&password=${password}`);
    if (response.ok) {
      currentUser = await response.json();
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      showApp();
    } else {
      document.getElementById('login-error').classList.add('show');
      setTimeout(() => document.getElementById('login-error').classList.remove('show'), 3000);
    }
  } catch (error) {
    showToast('Unable to connect to server', 'âŒ');
  }
}

function handleLogout() {
  currentUser = null;
  localStorage.removeItem('currentUser');
  document.getElementById('app-container').classList.add('hidden');
  document.getElementById('login-page').classList.remove('hidden');
}

async function showApp() {
  document.getElementById('login-page').classList.add('hidden');
  document.getElementById('app-container').classList.remove('hidden');
  
  const initials = currentUser.name.split(' ').slice(0,2).map(n => n[0]).join('').toUpperCase();
  document.getElementById('user-avatar').textContent = initials;
  document.getElementById('user-name').textContent = currentUser.name;
  document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'Administrator' : 'Employee';
  
  await loadEmployees();
  buildMenu();
  loadDashboard();
}

async function loadEmployees() {
  try {
    const response = await fetch(`${API_URL}/employees`);
    allEmployees = await response.json();
  } catch (error) {
    console.error('Failed to load employees');
  }
}

function buildMenu() {
  const nav = document.getElementById('sidebar-nav');
  if (currentUser.role === 'admin') {
    nav.innerHTML = `
      <div class="nav-section">MENU</div>
      <button class="nav-item active" onclick="showPage('dashboard')"><span class="nav-icon">ğŸ“Š</span>Dashboard</button>
      <button class="nav-item" onclick="showPage('employees')"><span class="nav-icon">ğŸ‘¥</span>Employees</button>
      <button class="nav-item" onclick="showPage('attendance')"><span class="nav-icon">â°</span>Attendance</button>
      <button class="nav-item" onclick="showPage('reports')"><span class="nav-icon">ğŸ“ˆ</span>Reports</button>
    `;
  } else {
    nav.innerHTML = `
      <div class="nav-section">MY PORTAL</div>
      <button class="nav-item active" onclick="showPage('dashboard')"><span class="nav-icon">ğŸ </span>Dashboard</button>
      <button class="nav-item" onclick="showPage('my-reports')"><span class="nav-icon">ğŸ“„</span>My Reports</button>
    `;
  }
}

async function loadDashboard() {
  const page = document.getElementById('page-dashboard');
  
  if (currentUser.role === 'admin') {
    const stats = await fetch(`${API_URL}/stats`).then(r => r.json());
    
    page.innerHTML = `
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ‘¥</div>
          <div class="stat-value">${stats.total_employees}</div>
          <div class="stat-label">Total Employees</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ’°</div>
          <div class="stat-value">EGP ${(stats.monthly_payroll / 1000000).toFixed(2)}M</div>
          <div class="stat-label">Monthly Payroll</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ¢</div>
          <div class="stat-value">5</div>
          <div class="stat-label">Companies (ECGS)</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">âœ…</div>
          <div class="stat-value">${stats.present_today || 0}</div>
          <div class="stat-label">Present Today</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸ” Quick Employee Search</div>
        </div>
        <div class="card-body">
          <p style="margin-bottom:16px;color:var(--gray-600)">Search by Employee ID to generate detailed reports</p>
          <button class="btn btn-primary" onclick="openModal('emp-search')" style="width:100%;justify-content:center">ğŸ” Search Employee</button>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <div class="card-title">Quick Reports</div>
        </div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
            <button class="btn btn-primary" onclick="generateReconciliation()">ğŸ“Š Payroll Reconciliation</button>
            <button class="btn btn-primary" onclick="showPage('employees')">ğŸ‘¥ View All Employees</button>
            <button class="btn btn-primary" onclick="showPage('attendance')">â° Attendance Records</button>
          </div>
        </div>
      </div>
    `;
  } else {
    page.innerHTML = `
      <div style="background:linear-gradient(135deg,#1565C0,#0D47A1);border-radius:12px;padding:32px;color:#fff;margin-bottom:28px">
        <h1 style="font-size:32px;font-weight:800">Welcome, ${currentUser.name.split(' ')[0]}! ğŸ‘‹</h1>
        <p style="opacity:.9;font-size:16px">Mido System - ECGS Group</p>
      </div>
      
      <div class="card">
        <div class="card-header">
          <div class="card-title">My Reports</div>
        </div>
        <div class="card-body">
          <button class="btn btn-primary" onclick="generateMyPayslip()" style="width:100%;justify-content:center;margin-bottom:12px">ğŸ“„ View My Payslip</button>
          <button class="btn btn-primary" onclick="showPage('my-reports')" style="width:100%;justify-content:center">ğŸ“Š All My Reports</button>
        </div>
      </div>
    `;
  }
}

async function loadEmployeesPage() {
  const page = document.getElementById('page-employees');
  
  page.innerHTML = `
    <div class="card">
      <div class="card-header">
        <div class="card-title">Employee Directory (${allEmployees.length} employees)</div>
      </div>
      <div class="card-body">
        <div class="table-wrap">
          <table>
            <thead><tr><th>Code</th><th>Name</th><th>Company</th><th>Department</th><th>Position</th><th>Salary</th></tr></thead>
            <tbody>
              ${allEmployees.slice(0, 50).map(e => `
                <tr onclick="viewEmployeeReport('${e.employee_code}')" style="cursor:pointer">
                  <td><strong>${e.employee_code}</strong></td>
                  <td>${e.name}</td>
                  <td>${e.company_name || 'ECGS'}</td>
                  <td>${e.department_name || '-'}</td>
                  <td>${e.position_name || '-'}</td>
                  <td>EGP ${(e.base_salary + e.allowances).toLocaleString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <p style="margin-top:16px;text-align:center;color:var(--gray-500)">Showing first 50 employees. Use search to find specific employee.</p>
      </div>
    </div>
  `;
}

function searchEmployees() {
  const query = document.getElementById('search-emp-input').value.toLowerCase();
  const results = allEmployees.filter(e => 
    e.employee_code.toLowerCase().includes(query) || 
    e.name.toLowerCase().includes(query)
  ).slice(0, 20);
  
  const container = document.getElementById('search-results');
  if (query.length < 2) {
    container.innerHTML = '<p style="color:var(--gray-500);text-align:center;padding:20px">Enter at least 2 characters to search</p>';
    return;
  }
  
  container.innerHTML = results.length > 0 ? results.map(e => `
    <div style="padding:12px;border:1px solid var(--gray-200);border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all .2s" 
         onclick="viewEmployeeReport('${e.employee_code}')" 
         onmouseover="this.style.background='var(--gray-50)'" 
         onmouseout="this.style.background='#fff'">
      <strong>${e.employee_code}</strong> - ${e.name}<br>
      <small style="color:var(--gray-500)">${e.company_name || 'ECGS'} â€¢ ${e.position_name || 'Position'}</small>
    </div>
  `).join('') : '<p style="color:var(--gray-500);text-align:center;padding:20px">No employees found</p>';
}

async function viewEmployeeReport(empCode) {
  closeModal('emp-search');
  showToast('Loading employee report...', 'â³');
  
  // Find employee
  const emp = allEmployees.find(e => e.employee_code === empCode);
  if (!emp) {
    showToast('Employee not found', 'âŒ');
    return;
  }
  
  // Get payroll data
  const payroll = await fetch(`${API_URL}/payroll?employee_id=${emp.id}`).then(r => r.json());
  if (!payroll.length) {
    showToast('No payroll data found', 'âŒ');
    return;
  }
  
  generateArabicPayslipForEmployee(emp, payroll[0]);
}

function generateArabicPayslipForEmployee(emp, payroll) {
  document.getElementById('report-title').textContent = 'Ø¨ÙŠØ§Ù† Ø§Ù„Ù…Ø±ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ';
  document.getElementById('report-viewer').innerHTML = `
    <div class="arabic-report">
      <div class="report-header-orange">Ø¨ÙŠØ§Ù† Ø§Ù„Ù…Ø±ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>
      
      <div style="text-align:left;margin:16px 0">
        <strong>Ø§Ù„ØªØ§Ø±ÙŠØ® / Ø´Ù‡Ø± Ø§Ù„ØµØ±Ù:</strong> ${payroll.month}-${payroll.year}<br>
        <strong>e-mail:</strong><br>
        <strong>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø«Ø§Ø¨Øª:</strong> ${emp.id}
      </div>
      
      <div style="text-align:left;margin:16px 0">
        <strong>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</strong> ${emp.name}<br>
        <strong>Ø§Ù„ÙˆØ¸ÙŠÙØ©:</strong> ${emp.position_name || 'Ù…ÙˆØ¸Ù'}<br>
        <strong>Ø§Ù„Ù‚Ø³Ù… / Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:</strong> ${emp.department_name || 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©'}
      </div>
      
      <div class="report-header-orange" style="margin-top:20px">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</div>
      <div style="background:#FDD835;padding:16px;text-align:center;font-size:24px;font-weight:700;margin-bottom:20px">
        ${emp.employee_code}
      </div>
      
      <div class="report-section">
        <div class="section-header-blue">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ: ${emp.bank_name || 'CIB'}</div>
        <div class="section-body">
          <table class="report-table">
            <tr><td>Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¨Ù†ÙƒÙŠ</td><td>${emp.bank_account || '100064795842'}</td></tr>
            <tr><td>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ</td><td>71238328</td></tr>
          </table>
        </div>
      </div>
      
      <div class="report-section">
        <div class="section-header-blue">Ø§Ù„Ø¶Ø±ÙŠØ¨ Ø§Ù„ØªØ£Ù…ÙŠÙ†ÙŠ</div>
        <div class="section-body">
          <table class="report-table">
            <tr><td>ØªØ£Ù…ÙŠÙ†Ø§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©</td><td>${payroll.social_insurance.toLocaleString()} EGP</td></tr>
          </table>
        </div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:16px 0">
        <div class="report-section">
          <div class="section-header-blue">Ø§Ù„Ø¥Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª</div>
          <div class="section-body">
            <table class="report-table">
              <tr><td>Ù…Ø±ØªØ¨ Ø£Ø³Ø§Ø³ÙŠ</td><td>${payroll.base_salary.toLocaleString()}</td></tr>
              ${payroll.allowances > 0 ? `<tr><td>Ø¨Ø¯Ù„Ø§Øª Ø£Ø®Ø±Ù‰</td><td>${payroll.allowances.toLocaleString()}</td></tr>` : ''}
              ${payroll.other_allowances > 0 ? `<tr><td>ØºÙŠØ§Ø¨ ÙˆØªØ£Ø®ÙŠØ±Ø§Øª</td><td>-</td></tr>` : ''}
              <tr><td>Ø¨Ø¯Ù„ Ù…Ù†Ø·Ù‚Ø©</td><td>-</td></tr>
              <tr><td>Ø¨Ø¯Ù„ Ù…Ø¹Ø¯Ø§Øª</td><td>-</td></tr>
              <tr><td>Ø­ÙˆØ§ÙØ² / Ù…ÙƒØ§ÙØ¢Øª</td><td>-</td></tr>
              <tr><td>Ø§Ø¬Ø± Ø¥Ø¶Ø§ÙÙŠ</td><td>-</td></tr>
            </table>
          </div>
        </div>
        
        <div class="report-section">
          <div class="section-header-blue">Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª</div>
          <div class="section-body">
            <table class="report-table">
              <tr><td>Ø¶Ø±Ø§Ø¦Ø¨</td><td>${payroll.tax.toLocaleString()}</td></tr>
              <tr><td>Ø³Ù„Ù</td><td>-</td></tr>
              <tr><td>Ù„Ø§Ø¦Ø­ÙŠÙˆÙ…</td><td>-</td></tr>
              <tr><td>Ø£Ø®Ø±Ù‰</td><td>-</td></tr>
            </table>
          </div>
        </div>
      </div>
      
      <div style="background:#FDD835;padding:12px 20px;text-align:center;font-weight:700;margin:20px 0">
        <div>Ù…ÙŠØ³ Ø§Ù„Ø³Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ ÙˆØ§Ù„Ù…ÙƒØ§ÙØ¢Øª</div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div style="background:#4CAF50;color:#fff;padding:16px;text-align:center;border-radius:8px">
          <div style="font-size:14px">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚Ø§Øª</div>
          <div style="font-size:24px;font-weight:700">${payroll.gross_salary.toLocaleString()}</div>
        </div>
        <div style="background:#EF5350;color:#fff;padding:16px;text-align:center;border-radius:8px">
          <div style="font-size:14px">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª</div>
          <div style="font-size:24px;font-weight:700">${payroll.total_deductions.toLocaleString()}</div>
        </div>
      </div>
      
      <div class="report-footer-gold" style="margin-top:20px">
        ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ù…Ø³ØªØ­Ù‚ (Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡): ${payroll.net_salary.toLocaleString()}
      </div>
    </div>
  `;
  
  openModal('report-viewer');
}

async function generateMyPayslip() {
  const emp = allEmployees.find(e => e.id === currentUser.employee_id);
  if (!emp) return showToast('Employee data not found', 'âŒ');
  
  const payroll = await fetch(`${API_URL}/payroll?employee_id=${currentUser.employee_id}`).then(r => r.json());
  if (!payroll.length) return showToast('No payroll data', 'âŒ');
  
  generateArabicPayslipForEmployee(emp, payroll[0]);
}

async function generateReconciliation() {
  const payroll = await fetch(`${API_URL}/payroll`).then(r => r.json());
  
  const nov = payroll.filter(p => p.month === 'November' && p.year === 2024);
  const dec = payroll.filter(p => p.month === 'December' && p.year === 2024);
  
  document.getElementById('report-title').textContent = 'Monthly Payroll Reconciliation';
  document.getElementById('report-viewer').innerHTML = `
    <div style="text-align:center">
      <div style="background:#1565C0;color:#fff;padding:12px;border-radius:8px;margin-bottom:20px">
        <h1 style="font-size:20px">Monthly Payroll reconciliation</h1>
      </div>
      
      <table class="reconciliation-table">
        <thead>
          <tr style="background:#B71C1C">
            <th>Ø§Ù„ÙØ±ÙˆÙ‚</th>
            <th>Dec-24</th>
            <th>Nov-24</th>
            <th>Ø§Ù„Ø´Ù‡Ø±</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>${dec.length - nov.length}</td>
            <td>${dec.length}</td>
            <td>${nov.length}</td>
            <td style="text-align:right">Ø¹Ø¯Ø¯ Ø¹Ù…Ù„Ø§Ø¦ÙŠ</td>
          </tr>
          <tr style="background:#fff">
            <td colspan="4"></td>
          </tr>
          <tr class="green-row">
            <td>${((dec.reduce((s,p) => s + p.gross_salary, 0) - nov.reduce((s,p) => s + p.gross_salary, 0)) / 1000).toFixed(2)}</td>
            <td>${(dec.reduce((s,p) => s + p.gross_salary, 0) / 1000).toFixed(2)}</td>
            <td>${(nov.reduce((s,p) => s + p.gross_salary, 0) / 1000).toFixed(2)}</td>
            <td style="text-align:right">Ø§Ø¬Ù…Ø§Ù„Ù‰ Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª</td>
          </tr>
          <tr class="yellow-row">
            <td>54.72%</td>
            <td style="font-weight:normal">**********</td>
            <td>0.0%</td>
            <td style="text-align:right">Ù…Ø§Ù„ÙŠØ© - Ø³Ù„Ù</td>
          </tr>
        </tbody>
      </table>
      
      <div style="margin-top:30px;padding:20px;background:var(--gray-50);border-radius:8px;text-align:left">
        <h3 style="margin-bottom:10px">Analysis:</h3>
        <p style="color:var(--gray-700)">
          Total employees: ${dec.length} (Dec) vs ${nov.length} (Nov)<br>
          Total payroll increased by EGP ${((dec.reduce((s,p) => s + p.net_salary, 0) - nov.reduce((s,p) => s + p.net_salary, 0)) / 1000).toFixed(2)}K
        </p>
      </div>
    </div>
  `;
  
  openModal('report-viewer');
}

function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  
  document.getElementById(`page-${name}`).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.getAttribute('onclick')?.includes(`'${name}'`)) n.classList.add('active');
  });
  
  const titles = {
    dashboard: 'Dashboard',
    employees: 'Employee Directory',
    reports: 'Reports & Analytics',
    attendance: 'Attendance Management',
    'my-reports': 'My Reports'
  };
  
  document.getElementById('page-title').textContent = titles[name] || 'Page';
  
  if (name === 'employees') loadEmployeesPage();
}

function openModal(name) {
  document.getElementById(`modal-${name}`).classList.add('open');
}

function closeModal(name) {
  document.getElementById(`modal-${name}`).classList.remove('open');
}

function toggleLang() {
  const label = document.getElementById('lang-label');
  label.textContent = label.textContent === 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' ? 'English' : 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©';
}

function downloadReport() {
  window.print();
}

let toastTimer;
function showToast(msg, icon = 'âœ…') {
  const toast = document.getElementById('toast');
  document.getElementById('toast-msg').textContent = msg;
  document.getElementById('toast-icon').textContent = icon;
  toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove('show'), 3000);
}

document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

window.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem('currentUser');
  if (saved) {
    currentUser = JSON.parse(saved);
    showApp();
  }
});
</script>
</body>
</html>
